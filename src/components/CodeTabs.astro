---
/**
 * CodeTabs component.
 * A client-side web component (<code-tabs>) that manages switching between multiple
 * <CodeTabItem> children. Useful for showing code in different languages.
 */
---

<script nonce="NGINX_CSP_NONCE" lang="ts">
    class CodeTabs extends HTMLElement {
        constructor() {
            super();
            const headers = this.querySelector(".tab-headers");
            const panels = this.querySelectorAll(".code-tab-panel");

            if (!headers || panels.length === 0) return;

            // Generate a unique ID for this tab group to avoid collisions
            const uniqueId = Math.random().toString(36).substring(2, 9);

            panels.forEach((panel, index) => {
                const title =
                    panel.getAttribute("data-label") || `Tab ${index + 1}`;
                const panelId = `panel-${uniqueId}-${index}`;
                const tabId = `tab-${uniqueId}-${index}`;

                // Setup Panel ARIA
                panel.setAttribute("id", panelId);
                panel.setAttribute("role", "tabpanel");
                panel.setAttribute("aria-labelledby", tabId);
                // Ensure panel is focusable if it has content, but usually code blocks handle their own focus
                // strict ARIA often suggests tabindex="0" on the panel if content is interactive, but for code blocks it might be overkill.
                // We'll stick to the roles first.

                // Create Tab Button
                const button = document.createElement("button");
                button.textContent = title;
                button.id = tabId;
                button.role = "tab";
                button.setAttribute("aria-controls", panelId);
                button.setAttribute(
                    "aria-selected",
                    index === 0 ? "true" : "false",
                );
                // Only the selected tab should be in the tab sequence
                button.setAttribute("tabindex", index === 0 ? "0" : "-1");

                button.addEventListener("click", () => {
                    // Deactivate all
                    headers.querySelectorAll("button").forEach((b) => {
                        b.setAttribute("aria-selected", "false");
                        b.setAttribute("tabindex", "-1");
                    });
                    panels.forEach((p) => {
                        if (p instanceof HTMLElement) p.style.display = "none";
                    });

                    // Activate clicked
                    button.setAttribute("aria-selected", "true");
                    button.setAttribute("tabindex", "0");

                    // Show corresponding panel
                    // Using direct reference since we created the closure
                    if (panel instanceof HTMLElement)
                        panel.style.display = "block";
                });

                // Keyboard navigation (Arrows)
                button.addEventListener("keydown", (e) => {
                    if (e.key === "ArrowRight") {
                        e.preventDefault();
                        const next = button.nextElementSibling;
                        if (next instanceof HTMLElement) {
                            next.click();
                            next.focus();
                        }
                    }
                    if (e.key === "ArrowLeft") {
                        e.preventDefault();
                        const prev = button.previousElementSibling;
                        if (prev instanceof HTMLElement) {
                            prev.click();
                            prev.focus();
                        }
                    }
                });

                headers.appendChild(button);

                // Initial state
                if (index !== 0) {
                    if (panel instanceof HTMLElement)
                        panel.style.display = "none";
                } else {
                    if (panel instanceof HTMLElement)
                        panel.style.display = "block";
                }
            });
        }
    }

    customElements.define("code-tabs", CodeTabs);
</script>

<style is:global>
    /* Use is:global to target the structure we create/expect */
    code-tabs {
        display: block;
        border: var(--border-subtle);
        border-radius: 8px;
        background: var(--color-bg-subtle);
        overflow: hidden;
        margin: 1.5rem 0;
    }

    .tab-headers {
        display: flex;
        background: var(--color-bg-secondary);
        border-bottom: 1px solid var(--color-border);
        overflow-x: auto;
        overflow-y: hidden; /* Prevent vertical scrollbar */
    }

    .tab-headers button {
        appearance: none;
        background: transparent;
        border: none;
        padding: 0.75rem 1.25rem;
        color: var(--color-text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        border-right: 1px solid var(--color-border);
        transition: all 0.2s;
        white-space: nowrap; /* Prevent text wrap */
        flex-shrink: 0; /* Prevent shrinking */
    }

    .tab-headers button:hover {
        color: var(--color-text-body);
        background: rgba(255, 255, 255, 0.02);
    }

    .tab-headers button[aria-selected="true"] {
        color: var(--color-primary);
        background: var(--color-bg-subtle);
        border-bottom: 2px solid var(--color-primary);
        margin-bottom: -1px;
        font-weight: 500;
    }

    .code-tab-panel {
        padding: 0;
        margin: 0;
        /* Ensure only the active panel is shown. The JS handles display property. */
    }

    /* Override expressive code margins inside tabs */
    .code-tab-panel :global(.expressive-code) {
        margin: 0 !important;
        border-radius: 0 !important;
        border: none !important;
    }

    .code-tab-panel :global(figure) {
        margin: 0 !important;
        border: none !important;
        border-radius: 0 !important;
    }

    /* Fix for potential double rendering or layout shifts */
    code-tabs:not(:defined) .tab-panels {
        visibility: hidden;
    }
</style>

<code-tabs>
    <div class="tab-headers" role="tablist" aria-label="Code Snippets"></div>
    <slot />
</code-tabs>
