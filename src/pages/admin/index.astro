---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Admin - Create Post">
    <div class="admin-container">
        <div class="editor-pane">
            <div class="toolbar">
                <h1>Create New Post</h1>
                <button id="save-btn" class="primary-btn">Save Post</button>
                <span id="status-message"></span>
            </div>

            <div class="form-group">
                <input
                    type="text"
                    id="title"
                    placeholder="Post Title"
                    required
                    class="input-field header-input"
                />
            </div>

            <div class="meta-row">
                <input type="date" id="date" required class="input-field" />
                <input
                    type="text"
                    id="tags"
                    placeholder="Tags (comma separated, e.g. code, astro)"
                    class="input-field"
                />
            </div>

            <div class="form-group">
                <textarea
                    id="description"
                    placeholder="Short description..."
                    class="input-field short-text"
                    rows="2"></textarea>
            </div>

            <div class="editor-wrapper">
                <textarea
                    id="content"
                    placeholder="Write your markdown here..."
                    class="input-field mono-font"></textarea>
            </div>
        </div>

        <div class="preview-pane">
            <div class="preview-header">Preview</div>
            <div id="preview" class="prose"></div>
            <!-- "prose" class often used for typography plugins, adjusting to typically match blog content wrapper -->
        </div>
    </div>
</BaseLayout>

<script>
    import { marked } from "marked";

    // --- custom element: CodeTabs (copied/adapted from component) ---
    class CodeTabs extends HTMLElement {
        constructor() {
            super();
            // We need to wait for children to be parsed if possible, or run this
            // logic when connected or on a specific trigger.
            // In the live preview context, innerHTML is replaced, so this element is created afresh.
        }

        connectedCallback() {
            // Slight delay to ensure children (panels) are present from innerHTML parse
            setTimeout(() => this.init(), 0);
        }

        init() {
            const headers = this.querySelector(".tab-headers");
            const panels = this.querySelectorAll(".code-tab-panel");

            if (!headers || panels.length === 0) return;

            // specific logic: clear headers first in case re-init
            headers.innerHTML = "";

            panels.forEach((panel, index) => {
                const title =
                    panel.getAttribute("data-label") || `Tab ${index + 1}`;
                const button = document.createElement("button");
                button.textContent = title;
                button.role = "tab";
                button.setAttribute(
                    "aria-selected",
                    index === 0 ? "true" : "false",
                );

                button.addEventListener("click", () => {
                    headers
                        .querySelectorAll("button")
                        .forEach((b) =>
                            b.setAttribute("aria-selected", "false"),
                        );
                    panels.forEach(
                        (p) => ((p as HTMLElement).style.display = "none"),
                    );
                    button.setAttribute("aria-selected", "true");

                    // Simple show logic
                    (panel as HTMLElement).style.display = "block";
                });

                headers.appendChild(button);
                if (index !== 0) (panel as HTMLElement).style.display = "none";
                else (panel as HTMLElement).style.display = "block";
            });
        }
    }

    if (!customElements.get("code-tabs")) {
        customElements.define("code-tabs", CodeTabs);
    }
    // ----------------------------------------------------------------

    const titleInput = document.getElementById("title") as HTMLInputElement;
    const dateInput = document.getElementById("date") as HTMLInputElement;
    const tagsInput = document.getElementById("tags") as HTMLInputElement;
    const descInput = document.getElementById(
        "description",
    ) as HTMLTextAreaElement;
    const contentInput = document.getElementById(
        "content",
    ) as HTMLTextAreaElement;
    const previewDiv = document.getElementById("preview") as HTMLDivElement;
    const saveBtn = document.getElementById("save-btn") as HTMLButtonElement;
    const statusMsg = document.getElementById(
        "status-message",
    ) as HTMLSpanElement;

    // Set default date to today
    dateInput.valueAsDate = new Date();

    // Icons for Callouts (SVG paths from MDI)
    const ICONS = {
        info: '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>',
        warning:
            '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16" /></svg>',
        error: '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M11,15H13V17H11V15M11,7H13V13H11V7M12,2C6.47,2 2,6.5 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20Z" /></svg>',
        success:
            '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M11,16.25L16.75,10.5L15.36,9.08L11,13.43L8.64,11.09L7.25,12.5L11,16.25Z" /></svg>',
    };

    // Helper to strip common indentation
    const dedent = (str: string) => {
        const lines = str.split("\n");
        // Find min indent of first non-empty line (ignoring first line if it's just newline from capture)
        let minIndent = Infinity;
        // Check indentation of filtered non-empty lines
        const contentLines = lines.filter((l) => l.trim().length > 0);
        if (contentLines.length === 0) return str.trim();

        contentLines.forEach((line) => {
            const indent = line.match(/^\s*/)?.[0].length || 0;
            if (indent < minIndent) minIndent = indent;
        });

        if (minIndent === Infinity) return str;

        return lines
            .map((l) => {
                if (l.trim().length === 0) return l; // preserve empty lines
                return l.startsWith(" ".repeat(minIndent))
                    ? l.slice(minIndent)
                    : l;
            })
            .join("\n")
            .trim();
    };

    const processCustomComponents = (md: string) => {
        let processed = md;

        // Callout - Relaxed regex (whitespace allowed in attributes)
        // Match <Callout type="..."> ... </Callout>
        processed = processed.replace(
            /<Callout\s+type\s*=\s*"([^"]+)"\s*>([\s\S]*?)<\/Callout>/g,
            (match, type, content) => {
                const icon = ICONS[type as keyof typeof ICONS] || ICONS.info;
                // Render markdown inside callout
                // IMPORTANT: Return string MUST NOT have indentation to avoid "indented code block" interpretation by marked
                return `<div class="callout callout-${type}"><div class="icon">${icon}</div><div class="content">${marked.parse(dedent(content))}</div></div>`;
            },
        );

        // YouTube - Relaxed regex
        processed = processed.replace(
            /<YouTube\s+id\s*=\s*"([^"]+)"(?: \s*title\s*=\s*"([^"]*)")?\s*\/>/g,
            (match, id, title) => {
                return `<div class="youtube-embed"><iframe src="https://www.youtube.com/embed/${id}" title="${title || "YouTube Video"}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
            },
        );

        // CodeTabs - Outer Wrapper
        processed = processed.replace(
            /<CodeTabs\s*>([\s\S]*?)<\/CodeTabs>/g,
            (match, content) => {
                // Return web component wrapper. Inner CodeTabItems will be processed in next pass.
                // ZERO INDENTATION important here too.
                return `<code-tabs><div class="tab-headers"></div>${content}</code-tabs>`;
            },
        );

        // CodeTabItem - Inner Panel
        // Use dedent() on content to fix code block detection
        processed = processed.replace(
            /<CodeTabItem\s+label\s*=\s*"([^"]+)"\s*>([\s\S]*?)<\/CodeTabItem>/g,
            (match, label, content) => {
                const cleanContent = dedent(content);
                // Important: marked should parse this clean content.
                return `<div class="code-tab-panel" data-label="${label}">${marked.parse(cleanContent)}</div>`;
            },
        );

        // Math $$...$$
        processed = processed.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
            return `<div class="math-block">$$${math}$$</div>`;
        });

        // Inline Math
        processed = processed.replace(
            /([^\\\$])\$([^\$]+)\$/g,
            (match, prefix, math) => {
                return `${prefix}<span class="math-inline">\\(${math}\\)</span>`;
            },
        );

        return processed;
    };

    const updatePreview = () => {
        const rawMarkdown = contentInput.value;
        const withComponents = processCustomComponents(rawMarkdown);
        previewDiv.innerHTML = marked.parse(withComponents) as string;

        // Highlight.js
        if ((window as any).hljs) {
            (window as any).hljs.highlightAll();
        }

        // MathJax
        if ((window as any).MathJax) {
            (window as any).MathJax.typesetPromise &&
                (window as any).MathJax.typesetPromise([previewDiv]);
        }
    };

    contentInput.addEventListener("input", updatePreview);

    // Initial Scripts Load (MathJax + Highlight.js)
    if (!document.getElementById("mathjax-script")) {
        const script = document.createElement("script");
        script.id = "mathjax-script";
        script.src =
            "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
        script.async = true;
        document.head.appendChild(script);
    }

    if (!document.getElementById("hljs-script")) {
        // CSS
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href =
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
        document.head.appendChild(link);

        // JS
        const script = document.createElement("script");
        script.id = "hljs-script";
        script.src =
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js";
        script.async = true;
        script.onload = () => {
            // Initial highlight if content exists
            updatePreview();
        };
        document.head.appendChild(script);
    }

    saveBtn.addEventListener("click", async () => {
        const title = titleInput.value;
        const date = dateInput.value;
        const tags = tagsInput.value;
        const description = descInput.value;
        const content = contentInput.value;

        if (!title || !date || !content) {
            statusMsg.textContent = "Missing required fields.";
            statusMsg.style.color = "red";
            return;
        }

        statusMsg.textContent = "Saving...";
        statusMsg.style.color = "orange";
        saveBtn.disabled = true;

        try {
            const response = await fetch("/api/save-post", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title,
                    date,
                    tags,
                    description,
                    content,
                }),
            });

            if (response.ok) {
                statusMsg.textContent = "Saved!";
                statusMsg.style.color = "lightgreen";
                setTimeout(() => {
                    statusMsg.textContent = "";
                }, 3000);
            } else {
                const errorData = await response.json();
                statusMsg.textContent = `Error: ${errorData.message || "Failed"}`;
                statusMsg.style.color = "red";
            }
        } catch (e) {
            console.error(e);
            statusMsg.textContent = "Network error.";
            statusMsg.style.color = "red";
        } finally {
            saveBtn.disabled = false;
        }
    });
</script>

<style>
    /* Admin Layout Structure */
    :global(body) {
        overflow: hidden;
    }

    .admin-container {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        background-color: var(--color-bg, #fff);
        color: var(--color-text, #000);
    }

    .editor-pane {
        width: 50%;
        display: flex;
        flex-direction: column;
        padding: 1rem;
        border-right: 1px solid var(--color-border, #30363d);
        overflow-y: auto;
    }

    .preview-pane {
        width: 50%;
        padding: 2rem;
        overflow-y: auto;
    }

    /* Toolbar, Input Styles */
    .toolbar {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--color-border, #30363d);
        padding-bottom: 0.5rem;
    }
    .toolbar h1 {
        margin: 0;
        font-size: 1.2rem;
        flex-grow: 1;
    }
    .form-group,
    .meta-row {
        margin-bottom: 0.5rem;
    }
    .meta-row {
        display: flex;
        gap: 0.5rem;
    }
    .meta-row input {
        flex: 1;
    }

    .input-field {
        width: 100%;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid var(--color-border, #ccc);
        padding: 0.5rem;
        border-radius: 4px;
        color: inherit;
        font-family: inherit;
    }
    @media (prefers-color-scheme: dark) {
        .input-field {
            background: rgba(0, 0, 0, 0.2);
        }
    }

    .header-input {
        font-size: 1.5rem;
        font-weight: bold;
    }
    #content {
        flex-grow: 1;
        min-height: 300px;
        resize: none;
    }
    .mono-font {
        font-family: "JetBrains Mono", monospace;
    }

    .primary-btn {
        background: var(--color-primary, #238636);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 5px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    .preview-header {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        color: var(--color-text-muted, #8b949e);
        margin-bottom: 1rem;
    }

    /* --- COMPONENT STYLES (Copied/Adapted) --- */

    /* Callout */
    :global(.callout) {
        display: flex;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-width: 0 0 0 4px; /* border-left: 4px solid */
        border-style: solid;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
    }
    :global(.callout .icon) {
        flex-shrink: 0;
        margin-top: 0.1rem;
    }
    /* Variants */
    :global(.callout-info) {
        border-color: var(--color-primary);
        background: rgba(59, 130, 246, 0.1);
        color: var(--color-primary);
    }
    :global(.callout-info .icon) {
        color: var(--color-primary);
    }

    :global(.callout-warning) {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }
    :global(.callout-warning .icon) {
        color: #f59e0b;
    }

    :global(.callout-error) {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    :global(.callout-error .icon) {
        color: #ef4444;
    }

    :global(.callout-success) {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }
    :global(.callout-success .icon) {
        color: #10b981;
    }

    :global(.callout .content) {
        color: var(--color-text);
        font-size: 0.95rem;
        line-height: 1.6;
    }
    :global(.callout .content p:last-child) {
        margin-bottom: 0;
    }
    :global(.callout .content p:first-child) {
        margin-top: 0;
    }

    /* YouTube */
    :global(.youtube-embed) {
        width: 100%;
        aspect-ratio: 16 / 9;
        background-color: var(--color-bg-secondary);
        border-radius: 8px; /* radius-md */
        overflow: hidden;
        margin: 2rem 0;
        box-shadow:
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    :global(.youtube-embed iframe) {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* CodeTabs WC Styles */
    :global(code-tabs) {
        display: block;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: var(--color-bg-secondary); /* or bg-subtle */
        overflow: hidden;
        margin: 1.5rem 0;
    }
    :global(.tab-headers) {
        display: flex;
        background: var(--color-bg-secondary);
        border-bottom: 1px solid var(--color-border);
        overflow-x: auto;
    }
    :global(.tab-headers button) {
        appearance: none;
        background: transparent;
        border: none;
        padding: 0.75rem 1.25rem;
        color: var(--color-text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        border-right: 1px solid var(--color-border);
        transition: all 0.2s;
    }
    :global(.tab-headers button:hover) {
        color: var(--color-text);
        background: rgba(255, 255, 255, 0.02);
    }
    :global(.tab-headers button[aria-selected="true"]) {
        color: var(--color-primary);
        background: var(--color-bg); /* bg-subtle often implies bg */
        border-bottom: 2px solid var(--color-primary);
        margin-bottom: -1px;
        font-weight: 500;
    }
    :global(.code-tab-panel) {
        padding: 0;
        margin: 0;
    }

    /* Global Elements */
    :global(.prose img) {
        max-width: 100%;
        height: auto;
    }
    :global(.prose table) {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    :global(.prose th),
    :global(.prose td) {
        border: 1px solid var(--color-border);
        padding: 0.5rem;
        text-align: left;
    }
    :global(.prose th) {
        background: var(--color-bg-secondary);
        font-weight: bold;
    }
    :global(.prose blockquote) {
        border-left: 4px solid var(--color-border);
        padding-left: 1rem;
        color: var(--color-text-muted);
        margin: 1rem 0;
    }

    /* PREVIEW: Code Block Styling (Simulating Expressive Code) */
    :global(.prose pre) {
        background: #0d1117; /* GitHub Dark */
        border: 1px solid var(--color-border);
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.9em;
        line-height: 1.5;
        color: #c9d1d9;
    }
    :global(.prose code) {
        font-family: "JetBrains Mono", monospace;
        background: rgba(110, 118, 129, 0.4);
        padding: 0.2em 0.4em;
        border-radius: 6px;
        font-size: 0.85em;
    }
    :global(.prose pre code) {
        background: transparent;
        padding: 0;
        border-radius: 0;
        color: inherit;
        font-size: 1em;
    }

    /* Math Block */
    :global(.math-block) {
        padding: 1rem;
        text-align: center;
        overflow-x: auto;
        background: transparent;
    }
</style>
```
