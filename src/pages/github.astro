---
/**
 * GitHub Repositories Page.
 * Displays GitHub repositories using SSG + Islands architecture.
 * Profile and top 12 repos are fetched at build time for optimal performance.
 * Search functionality is client-side only (no API calls).
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import { Image, getImage } from "astro:assets";
import githubAvatar from "../assets/github-avatar.png";
import { fetchGitHubProfile, fetchTopRepositories } from "../utils/github";
import GitHubSearch from "../components/github/GitHubSearch.astro";
import { Icon } from "astro-icon/components";

// Fetch data at build time (SSG)
const profile = await fetchGitHubProfile();
const repos = await fetchTopRepositories(12); // Top 12 most recently updated

const optimizedAvatar = await getImage({
    src: githubAvatar,
    format: "webp",
    width: 120,
    height: 120,
    widths: [60, 120, 240],
    sizes: "(max-width: 768px) 120px, 240px",
});

const avatarSrcSet = [60, 120, 240]
    .map(
        async (w) =>
            `${
                (
                    await getImage({
                        src: githubAvatar,
                        format: "webp",
                        width: w,
                        height: w,
                    })
                ).src
            } ${w}w`,
    )
    .reduce(async (acc, curr) => `${await acc}, ${await curr}`);

const avatarSrcSetString = await avatarSrcSet;
---

<BaseLayout
    title="GitHub Repositories"
    description="My Open Source Contributions"
>
    <link
        slot="head"
        rel="preload"
        as="image"
        imagesrcset={avatarSrcSetString}
        imagesizes="(max-width: 768px) 120px, 240px"
        fetchpriority="high"
    />
    <div class="container github-page">
        <h1 class="page-title">GitHub Repositories</h1>

        <!-- Profile Section - NOW STATIC SSG -->
        <div class="profile-header">
            <div class="profile-avatar">
                <Image
                    src={githubAvatar}
                    alt={profile.name}
                    width="120"
                    height="120"
                    widths={[60, 120, 240]}
                    sizes="(max-width: 768px) 120px, 240px"
                    loading="eager"
                    fetchpriority="high"
                />
            </div>
            <div class="profile-info">
                <h2>{profile.name}</h2>
                <a
                    href={profile.html_url}
                    class="username"
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    @{profile.login}
                </a>
                <p class="bio">{profile.bio || "Open Source Enthusiast"}</p>
                <div class="profile-stats">
                    <div class="stat">
                        <strong>{profile.public_repos}</strong>
                        <span> Repositories</span>
                    </div>
                    <div class="stat">
                        <strong>{profile.followers}</strong>
                        <span> Followers</span>
                    </div>
                    <div class="stat">
                        <strong>{profile.following}</strong>
                        <span> Following</span>
                    </div>
                </div>
                {
                    profile.location && (
                        <p class="location">
                            <Icon name="fa-solid:map-marker-alt" />{" "}
                            {profile.location}
                        </p>
                    )
                }
            </div>
        </div>

        <!-- Search and Repos Component - Progressive Enhancement -->
        <GitHubSearch initialRepos={repos} />
    </div>
</BaseLayout>

<style>
    .page-title {
        margin-bottom: var(--space-lg);
        border-bottom: var(--border-2);
        padding-bottom: var(--space-md);
    }

    /* Profile Header */
    .profile-header {
        background-color: var(--color-bg-secondary);
        border: var(--border-1);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-md);
        text-align: center;
        max-width: 100%;
        overflow: hidden;
    }

    /* Responsive Profile: Grid on Desktop */
    @media (min-width: 768px) {
        .profile-header {
            flex-direction: row;
            text-align: left;
            align-items: flex-start;
            gap: var(--space-xl);
        }

        .profile-stats {
            justify-content: flex-start !important;
        }

        .location {
            justify-content: flex-start !important;
        }
    }

    /* Profile Elements */
    .profile-avatar img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 3px solid var(--color-primary);
        max-width: 100%;
        object-fit: cover;
    }

    .profile-info {
        max-width: 100%;
        overflow-wrap: anywhere;
    }

    .profile-info h2 {
        margin: 0;
        font-size: 1.8rem;
        word-break: break-word;
    }

    .profile-info .username {
        color: var(--color-text-muted);
        text-decoration: none;
        margin-bottom: 8px;
        display: block;
    }

    .profile-info .bio {
        margin-bottom: 16px;
        max-width: 600px;
        overflow-wrap: anywhere;
        min-height: 1.5em; /* Stabilize for CLS */
    }

    .profile-stats {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: var(--space-md);
        max-width: 100%;
        overflow-wrap: anywhere;
        min-height: 1.5em; /* Stabilize for CLS */
    }

    .stat strong {
        color: var(--color-text);
        font-weight: var(--fw-bold);
    }

    .stat span {
        color: var(--color-text-muted);
    }

    .stat {
        min-height: 1.5em; /* Stabilize for micro-CLS */
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .location {
        margin-top: 12px;
        font-size: 0.9rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
    }
</style>
