---
/**
 * CV Page.
 * Displays curriculum vitae data loaded from `src/data/cv/cv.yml`.
 * Renders sections dynamically using specific components (SkillGroup, CertificateGroup) or generic map/timeline layouts.
 */
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCVData } from "@utils/cv";
import { Icon } from "astro-icon/components";
import SkillGroup from "@components/cv/SkillGroup.astro";
import CertificateGroup from "@components/cv/CertificateGroup.astro";
import { getEntry } from "astro:content";

const cvData = await getCVData();
const siteEntry = await getEntry("site", "config");
const siteData = siteEntry!.data;
const socialsEntry = await getEntry("socials", "main");
const socials = socialsEntry!.data;

// Helper to map FontAwesome classes to Iconify names
const getIconName = (faClass: string) => {
    if (!faClass) return "";
    const parts = faClass.split(" ");
    const style = parts[0]; // fab, fas
    const name = parts[1]?.replace("fa-", "") || "";

    if (style === "fab") return `fa-brands:${name}`;
    if (style === "fas") return `fa-solid:${name}`;
    return `fa-solid:${name}`; // Default
};

// Construct Person Schema
const personSchema = {
    "@context": "https://schema.org",
    "@type": "Person",
    name: siteData.author,
    jobTitle: "R&D Engineer", // Could also be in site.yml
    worksFor: {
        "@type": "Organization",
        name: "Power Electronics",
    },
    url: siteData.url,
    sameAs: [
        socials.github_username
            ? `https://github.com/${socials.github_username}`
            : "",
        socials.mastodon_username ? `https://${socials.mastodon_username}` : "",
        socials.linkedin_username
            ? `https://www.linkedin.com/in/${socials.linkedin_username}`
            : "",
    ].filter(Boolean),
    knowsAbout:
        cvData
            .find((s) => s.title === "Technical Skills")
            ?.contents?.flatMap((g) => {
                if ("items" in g) {
                    return g.items.map((i) => i.name);
                }
                return [];
            }) || [],
    alumniOf:
        cvData
            .find((s) => s.title === "Formal education")
            ?.contents?.map((edu) => {
                if ("institution" in edu) {
                    return {
                        "@type": "EducationalOrganization",
                        name: edu.institution,
                        department: edu.department,
                    };
                }
                return null;
            })
            .filter((e): e is Record<string, unknown> => !!e) || [],
};
---

<BaseLayout
    title="CV"
    description="Curriculum Vitae"
    type="profile"
    schema={personSchema}
>
    <div class="cv-container container">
        <div class="cv-header">
            <h1>Curriculum Vitae</h1>
        </div>

        <nav class="cv-toc" aria-label="Table of Contents">
            <ul>
                <li><a href="#general-information">General</a></li>
                <li><a href="#experience">Experience</a></li>
                <li><a href="#technical-skills">Skills</a></li>
                <li><a href="#formal-education">Education</a></li>
                <li><a href="#certificates">Certificates</a></li>
            </ul>
        </nav>

        {
            // Define custom order
            [
                cvData.find((s) => s.title === "General Information"),
                cvData.find((s) => s.title === "Experience"),
                cvData.find((s) => s.title === "Technical Skills"),
                cvData.find((s) => s.title === "Formal education"),
                cvData.find((s) => s.title === "Certificates"),
            ]
                .filter((s) => !!s)
                .map((section) => (
                    <section
                        class="cv-section"
                        id={section.title.toLowerCase().replace(/ /g, "-")}
                        aria-label={section.title}
                    >
                        <h2 class="section-title">{section.title}</h2>

                        {section.type === "map" && (
                            <div class="cv-map">
                                {section.contents.map((item) => (
                                    <div class="map-item">
                                        <strong>{item.name}:</strong>
                                        {item.value && (
                                            <span>{item.value}</span>
                                        )}
                                        {item.links && (
                                            <div class="links">
                                                {item.links.map((link) => (
                                                    <a
                                                        href={link.link}
                                                        class="btn-sm"
                                                        download={link.download || true}
                                                    >
                                                        {link.name}
                                                    </a>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {section.type === "time_table" && (
                            <div class="timeline">
                                {section.contents.map((item) => (
                                    <div class="timeline-item">
                                        <div
                                            class="timeline-dot"
                                            aria-hidden="true"
                                        />
                                        <div class="timeline-card">
                                            <div
                                                class="timeline-arrow"
                                                aria-hidden="true"
                                            />
                                            <div class="item-header">
                                                <h3>{item.title}</h3>
                                                <span class="year">
                                                    {item.year}
                                                </span>
                                            </div>
                                            {item.institution && (
                                                <div
                                                    class="institution"
                                                    style="min-height: 1.2em"
                                                    set:html={item.institution.replace(
                                                        /&(?!(amp|lt|gt|quot|apos);)/g,
                                                        "&amp;",
                                                    )}
                                                />
                                            )}
                                            {item.department && (
                                                <div
                                                    class="department"
                                                    set:html={item.department.replace(
                                                        /&(?!(amp|lt|gt|quot|apos);)/g,
                                                        "&amp;",
                                                    )}
                                                />
                                            )}
                                            {item.location && (
                                                <div class="location">
                                                    <Icon name="fa-solid:map-marker-alt" />{" "}
                                                    {item.location}
                                                </div>
                                            )}

                                            {item.summary && (
                                                <div
                                                    class="description summary"
                                                    style="min-height: 1.5em"
                                                    set:html={item.summary.replace(
                                                        /&(?!(amp|lt|gt|quot|apos);)/g,
                                                        "&amp;",
                                                    )}
                                                />
                                            )}

                                            {item.description && (
                                                <ul class="task-list">
                                                    {item.description.map(
                                                        (desc) => {
                                                            if (
                                                                typeof desc ===
                                                                "string"
                                                            )
                                                                return (
                                                                    <li>
                                                                        <div
                                                                            set:html={desc.replace(
                                                                                /&(?!(amp|lt|gt|quot|apos);)/g,
                                                                                "&amp;",
                                                                            )}
                                                                        />
                                                                    </li>
                                                                );
                                                            if (
                                                                desc.title &&
                                                                desc.contents
                                                            ) {
                                                                // Nested contents in description
                                                                return (
                                                                    <li>
                                                                        <strong>
                                                                            {
                                                                                desc.title
                                                                            }
                                                                        </strong>
                                                                        <ul>
                                                                            {desc.contents.map(
                                                                                (
                                                                                    sub: string,
                                                                                ) => (
                                                                                    <li>
                                                                                        <div
                                                                                            set:html={sub.replace(
                                                                                                /&(?!(amp|lt|gt|quot|apos);)/g,
                                                                                                "&amp;",
                                                                                            )}
                                                                                        />
                                                                                    </li>
                                                                                ),
                                                                            )}
                                                                        </ul>
                                                                    </li>
                                                                );
                                                            }
                                                            return null;
                                                        },
                                                    )}
                                                </ul>
                                            )}

                                            {item.linkitems && (
                                                <div class="timeline-links">
                                                    {item.linkitems.map(
                                                        (link) => (
                                                            <a
                                                                href={link.link}
                                                                class="btn-sm"
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                aria-label={
                                                                    link.ariaLabel
                                                                }
                                                            >
                                                                <Icon name="fa-solid:file-pdf" />
                                                                {link.linkname}
                                                            </a>
                                                        ),
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {section.type === "list_groups" && (
                            <div class="list-groups-compact">
                                {section.contents.map((group) => (
                                    <SkillGroup group={group} />
                                ))}
                            </div>
                        )}

                        {section.type === "certificate_list" && (
                            <div class="list-groups-compact">
                                {section.contents.map((group) => (
                                    <CertificateGroup group={group} />
                                ))}
                            </div>
                        )}
                    </section>
                ))
        }

        <style>
            .cv-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--space-md);
                border-bottom: var(--border-2);
                padding-bottom: var(--space-md);
            }

            .cv-toc {
                position: -webkit-sticky; /* Safari support */
                position: sticky;
                top: calc(var(--header-height) + 6px); /* Header + small gap */
                background: var(--color-bg);
                padding: var(--space-sm) 0;
                margin-bottom: var(--space-lg);
                z-index: 10;
                border-bottom: var(--border-1);
            }

            .cv-toc ul {
                display: flex;
                gap: var(--space-md);
                list-style: none;
                padding: 0;
                margin: 0;
                overflow-x: auto;
            }

            .cv-toc a {
                text-decoration: none;
                color: var(--color-text-muted);
                font-weight: var(--fw-semibold);
                font-size: 0.95rem;
                white-space: nowrap;
            }

            .cv-toc a:hover {
                color: var(--color-primary);
            }

            .cv-section {
                margin-bottom: var(--space-lg);
            }

            .section-title {
                /* Overriding global default to match CV preference (border-bottom) */
                border-left: none;
                border-bottom: var(--border-1);
                padding-left: 0;
            }

            /* Map Type */
            .cv-map {
                display: flex;
                flex-direction: column;
                gap: var(--space-sm);
            }

            .map-item {
                font-size: 1.1rem;
            }

            .links {
                display: inline-flex;
                gap: var(--space-sm);
                margin-left: var(--space-sm);
            }

            /* Time Table */
            .timeline {
                border-left: var(--border-2);
                padding-left: var(--space-lg);
            }

            .timeline-item {
                position: relative;
                margin-bottom: var(--space-lg);
            }

            .timeline-dot {
                position: absolute;
                left: calc(-1 * var(--space-lg) - 5px);
                top: 24px; /* Align with card top/header roughly */
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: var(--color-primary);
                z-index: 1;
            }

            .timeline-card {
                background-color: var(--color-bg-secondary);
                border: var(--border-1);
                border-radius: var(--radius-md);
                padding: var(--space-lg);
                position: relative;
                transition:
                    transform 0.2s,
                    border-color 0.2s;
            }

            .timeline-card:hover {
                transform: translateY(-2px);
                border-color: var(--color-primary);
            }

            /* Arrow pointing to timeline */
            .timeline-arrow {
                content: "";
                position: absolute;
                top: 20px;
                left: -8px;
                width: 16px;
                height: 16px;
                background-color: var(--color-bg-secondary);
                border-left: var(--border-1);
                border-bottom: var(--border-1);
                transform: rotate(45deg);
            }

            .timeline-card:hover .timeline-arrow {
                border-color: var(--color-primary); /* Match hover border */
            }

            .item-header {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                margin-bottom: var(--space-xs);
            }

            .year {
                font-family: var(--font-mono);
                color: var(--color-accent);
                font-weight: bold;
            }

            .institution,
            .department {
                font-size: 1.1rem;
                color: var(--color-text-muted);
                font-weight: var(--fw-medium);
            }

            .location {
                font-size: 0.9rem;
                color: var(--color-text-muted);
                font-style: italic;
                margin-bottom: var(--space-md);
            }

            .main-desc {
                margin-bottom: var(--space-md);
            }

            .task-list {
                padding-left: var(--space-lg);
            }

            .task-list li {
                margin-bottom: var(--space-xs);
            }

            .list-groups-compact {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: var(--space-lg) var(--space-lg);
                align-items: start;
            }

            .group-category {
                break-inside: avoid;
            }

            .list-groups-compact {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: var(--space-lg);
                margin-top: var(--space-md);
            }

            .timeline-links {
                display: flex;
                flex-wrap: wrap;
                gap: var(--space-sm);
                margin-top: var(--space-md);
                border-top: var(--border-1);
                padding-top: var(--space-sm);
            }

            .timeline-links a {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-weight: var(
                    --fw-link-emphasis
                ); /* Accessibility: Distinguish links by weight */
            }

            /* Accessibility: Distinguish links by weight
               Using :global() because these links are injected via set:html */
            .timeline-card :global(a),
            .map-item :global(a:not(.btn-sm)) {
                font-weight: var(--fw-link-emphasis);
            }

            /* Ensure button links also have sufficient weight if they are text-like */
            .map-item :global(.btn-sm) {
                font-weight: var(--fw-link-emphasis);
            }
        </style>
    </div></BaseLayout
>
